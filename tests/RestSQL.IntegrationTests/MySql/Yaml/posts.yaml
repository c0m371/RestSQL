endpoints:
  - path: /api/posts
    method: GET
    statusCode: 200
    sqlQueries:
      posts:
        connectionName: blog
        sql: >
          select id as PostId,
                 title as Title,
                 description as Description,
                 DATE_FORMAT(creation_date, '%Y-%m-%d %H:%i:%s') as CreationDate,
                 username as Username
          from posts
          order by id;
      tags: &tagsQuery
        connectionName: blog
        sql: >
          select post_id as PostId, tag as Tag
          from tags
          order by PostId, Tag;
    outputStructure:
      type: Object
      isArray: true
      queryName: posts
      fields: &postFields
        - { type: Long, name: id, columnName: PostId }
        - { type: String, name: title, columnName: Title }
        - { type: String, name: description, columnName: Description }
        - { type: String, name: username, columnName: Username }
        - { type: String, name: creationDate, columnName: CreationDate }
        - type: string
          isArray: true
          name: tags
          queryName: tags
          columnName: tag
          linkColumn: PostId
        
  - path: /api/posts
    method: POST
    statusCode: 200
    writeOperations:
      - connectionName: blog
        sql: >
          insert into posts (title, description, creation_date, username)
          values (@title, @description, @creationDate, @username);
          SELECT LAST_INSERT_ID() AS Id;
        bodyType: Object
        outputCaptures:
          - columnName: Id
            parameterName: PostId
    sqlQueries:
      posts:
        connectionName: blog
        sql: >
          select id as PostId,
                 title as Title,
                 description as Description,
                 DATE_FORMAT(creation_date, '%Y-%m-%d %H:%i:%s') as CreationDate,
                 username as Username
          from posts
          where id = @PostId;
      tags: *tagsQuery
    outputStructure:
      type: Object
      queryName: posts
      fields: *postFields

  - path: /api/posts/{Id:long}/tags
    method: POST
    statusCode: 200
    writeOperations:
      - connectionName: blog
        sql: >
          insert into tags (post_id, tag)
          values (CAST(@Id AS SIGNED), @Tag);
        bodyType: Value
        valueParameterName: Tag